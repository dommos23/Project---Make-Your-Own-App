{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Checkout | Clothing Store{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1>Checkout</h1>
        <form method="post" id="checkout-form">
            {% csrf_token %}
            <!-- Shipping info section unchanged -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Shipping Information</h5>
                </div>
                <div class="card-body">
                    {% if has_profile_address %}
                    <div class="mb-3 form-check">
                        {{ order_form.use_profile_address }}
                        <label class="form-check-label" for="{{ order_form.use_profile_address.id_for_label }}">
                            {{ order_form.use_profile_address.label }}
                        </label>
                        <small class="form-text text-muted">{{ order_form.use_profile_address.help_text }}</small>
                    </div>
                    <div id="shipping-fields">
                        {{ order_form.shipping_address|as_crispy_field }}
                        {{ order_form.shipping_city|as_crispy_field }}
                        {{ order_form.shipping_state|as_crispy_field }}
                        {{ order_form.shipping_zip|as_crispy_field }}
                        {{ order_form.shipping_country|as_crispy_field }}
                    </div>
                    {% else %}
                        {{ order_form|crispy }}
                    {% endif %}
                </div>
            </div>
            
            <!-- Add this JavaScript to toggle the shipping fields visibility -->
            {% block extra_js %}
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var useProfileAddressCheckbox = document.getElementById('{{ order_form.use_profile_address.id_for_label }}');
                    var shippingFields = document.getElementById('shipping-fields');
                    
                    if (useProfileAddressCheckbox) {
                        useProfileAddressCheckbox.addEventListener('change', function() {
                            if (this.checked) {
                                shippingFields.style.display = 'none';
                            } else {
                                shippingFields.style.display = 'block';
                            }
                        });
                    }
                });
            </script>
            {% endblock %}
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Payment Information</h5>
                </div>
                <div class="card-body">
                    <!-- Payment method field -->
                    <div class="mb-3">
                        <label for="{{ payment_form.payment_method.id_for_label }}">Payment Method</label>
                        {{ payment_form.payment_method }}
                    </div>
                    
                    <!-- Custom fields with validation -->
                    <div class="form-group mb-3">
                        <label for="card_number">Card Number</label>
                        <input type="text" name="card_number" id="card_number" class="form-control" required 
                               pattern="[0-9]{13,16}" title="Card number must be 13-16 digits">
                        <div class="invalid-feedback" id="card-number-error">
                            Please enter a valid card number (13-16 digits).
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="card_expiry">Expiration Date (MM/YY)</label>
                                <input type="text" name="card_expiry" id="card_expiry" class="form-control" required 
                                       pattern="(0[1-9]|1[0-2])\/[0-9]{2}" title="Please use MM/YY format (e.g. 05/25)">
                                <div class="invalid-feedback" id="card-expiry-error">
                                    Please enter a valid expiration date in MM/YY format.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="card_cvv">CVV</label>
                                <input type="text" name="card_cvv" id="card_cvv" class="form-control" required 
                                       pattern="[0-9]{3,4}" title="CVV must be 3-4 digits">
                                <div class="invalid-feedback" id="card-cvv-error">
                                    Please enter a valid CVV (3-4 digits).
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Complete Purchase</button>
        </form>
    </div>
    
    <!-- Order summary section unchanged -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for item in cart_items %}
                    <li class="list-group-item d-flex justify-content-between">
                        <div>
                            {{ item.product.name }} <span class="text-muted">x {{ item.quantity }}</span>
                        </div>
                        <div>${{ item.get_total_price }}</div>
                    </li>
                    {% endfor %}
                </ul>
                
                <!-- Add this section for discount information -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>${{ cart_total|floatformat:2 }}</span>
                    </div>
                    
                    {% if discount %}
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Discount ({{ discount.code }}):</span>
                        <span>-${{ discount_amount|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                    
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total:</span>
                        <span>${{ final_total|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('checkout-form');
        const cardNumber = document.getElementById('card_number');
        const cardExpiry = document.getElementById('card_expiry');
        const cardCvv = document.getElementById('card_cvv');
        
        form.addEventListener('submit', function(event) {
            let isValid = true;
            
            // Validate card number (13-16 digits)
            if (!cardNumber.value.match(/^[0-9]{13,16}$/)) {
                cardNumber.classList.add('is-invalid');
                isValid = false;
            } else {
                cardNumber.classList.remove('is-invalid');
            }
            
            // Validate expiry date (MM/YY format)
            if (!cardExpiry.value.match(/^(0[1-9]|1[0-2])\/[0-9]{2}$/)) {
                cardExpiry.classList.add('is-invalid');
                isValid = false;
            } else {
                cardExpiry.classList.remove('is-invalid');
            }
            
            // Validate CVV (3-4 digits)
            if (!cardCvv.value.match(/^[0-9]{3,4}$/)) {
                cardCvv.classList.add('is-invalid');
                isValid = false;
            } else {
                cardCvv.classList.remove('is-invalid');
            }
            
            if (!isValid) {
                event.preventDefault();
            }
        });
    });
</script>
{% endblock %}
{% endblock %}